<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de O.S EIP</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4a5568;
            --secondary-color: #2d3748;
            --accent-color: #5a67d8;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --primary-color: #a0aec0;
            --secondary-color: #cbd5e0;
            --accent-color: #667eea;
            --success-color: #68d391;
            --warning-color: #f6ad55;
            --danger-color: #fc8181;
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        header {
            background: var(--accent-color);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .theme-toggle {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .upload-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-bottom: 2px solid var(--border-color);
            transition: background 0.3s ease;
        }
        
        .upload-box {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-box:hover {
            border-color: var(--accent-color);
            background: var(--bg-tertiary);
        }
        
        .upload-box.dragover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: var(--text-muted);
        }
        
        .upload-text {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            padding: 0 30px;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            transition: background 0.3s ease;
        }
        
        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--accent-color);
        }
        
        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .content {
            padding: 30px;
            background: var(--bg-primary);
            transition: background 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--accent-color);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card.success {
            background: var(--success-color);
        }
        
        .stat-card.danger {
            background: var(--danger-color);
        }
        
        .stat-card.warning {
            background: var(--warning-color);
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.95;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .table-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        .table-scroll-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            color: var(--text-muted);
            font-size: 0.85em;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative; /* Importante para posicionar a lista suspensa */
        }
        
        .filter-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        /* Estilos da lista suspensa (Autocomplete) */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            box-shadow: var(--shadow-md);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .autocomplete-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }
        
        .autocomplete-suggestion:hover {
            background: var(--bg-tertiary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: var(--accent-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        tr:hover {
            background: var(--bg-tertiary);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-concluida {
            background: #d4edda;
            color: #155724;
        }
        
        [data-theme="dark"] .status-concluida {
            background: #2d5a3d;
            color: #68d391;
        }
        
        .status-andamento {
            background: #fff3cd;
            color: #856404;
        }
        
        [data-theme="dark"] .status-andamento {
            background: #5a4a1f;
            color: #f6ad55;
        }
        
        .status-cancelada {
            background: #f8d7da;
            color: #721c24;
        }
        
        [data-theme="dark"] .status-cancelada {
            background: #5a2a2d;
            color: #fc8181;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.3em;
            color: var(--accent-color);
        }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }
        
        .empty-state h2 {
            color: var(--text-primary);
            margin-top: 15px;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: var(--text-muted);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            header {
                padding: 20px 15px;
                padding-top: 60px;
            }
            
            header h1 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }
            
            header p {
                font-size: 0.9em;
            }
            
            .theme-toggle {
                position: absolute;
                top: 15px;
                right: 15px;
                left: auto;
                padding: 8px 15px;
                font-size: 0.85em;
            }
            
            .upload-section {
                padding: 15px;
            }
            
            .upload-box {
                padding: 25px 15px;
            }
            
            .upload-icon svg {
                width: 60px;
                height: 60px;
            }
            
            .upload-text {
                font-size: 0.95em;
            }
            
            .tabs {
                padding: 0 15px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 12px 20px;
                font-size: 1em;
                white-space: nowrap;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 18px;
            }
            
            .stat-label {
                font-size: 0.8em;
                margin-bottom: 8px;
            }
            
            .stat-value {
                font-size: 2em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-title {
                font-size: 1.1em;
                margin-bottom: 15px;
            }
            
            .chart-container canvas {
                max-height: 300px !important;
            }
            
            .table-container {
                padding: 15px;
            }
            
            .filter-section {
                gap: 10px;
            }
            
            .filter-wrapper {
                min-width: 100%;
            }
            
            .filter-input {
                padding: 10px;
                font-size: 0.95em;
            }
            
            .table-wrapper {
                border: 1px solid var(--border-color);
                border-radius: 8px;
                overflow: hidden;
            }
            
            table {
                font-size: 0.85em;
                min-width: 600px;
            }
            
            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            th {
                font-size: 0.8em;
                background: var(--accent-color);
            }
            
            td {
                border-right: 1px solid var(--border-color);
            }
            
            td:last-child {
                border-right: none;
            }
            
            .status-badge {
                font-size: 0.75em;
                padding: 4px 8px;
            }
            
            .empty-state {
                padding: 40px 20px;
            }
            
            .empty-state-icon svg {
                width: 80px;
                height: 80px;
            }
            
            .empty-state h2 {
                font-size: 1.3em;
            }
            
            .empty-state p {
                font-size: 0.9em;
            }
            
            .loading {
                padding: 40px 20px;
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.3em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            
            table {
                font-size: 0.75em;
                min-width: 500px;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle" id="themeToggle">Modo Escuro</button>
            <h1>Dashboard - Controle de O.S</h1>
            <p>Sistema de Análise de Ordens de Serviço - EIP</p>
        </header>
        
        <div class="upload-section">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <div class="upload-text">
                    Clique ou arraste o arquivo Excel aqui para carregar/atualizar os dados
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
        </div>
        
        <div class="tabs" id="tabsContainer" style="display: none;">
            <button class="tab active" data-year="2024">2024</button>
            <button class="tab" data-year="2025">2025</button>
            <button class="tab" data-year="2026">2026</button>
            <button class="tab" data-year="geral">Geral</button>
        </div>
        
        <div class="content" id="contentArea">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <h2>Nenhum dado carregado</h2>
                <p>Faça upload de um arquivo Excel para começar a análise</p>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        if (currentTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeToggle.textContent = 'Modo Claro';
        }
        
        themeToggle.addEventListener('click', () => {
            const theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'Modo Escuro';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'Modo Claro';
            }
            
            // Rerender charts if data exists
            if (Object.keys(workbookData).length > 0) {
                renderDashboard(currentYear);
            }
        });
        
        let workbookData = {};
        let currentYear = '2024';
        
        // Upload functionality
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const tabsContainer = document.getElementById('tabsContainer');
        const contentArea = document.getElementById('contentArea');
        
        uploadBox.addEventListener('click', () => fileInput.click());
        
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });
        
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });
        
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Helper para parsear datas de diferentes formatos
        function parseDateHelper(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            
            // String
            if (typeof value === 'string') {
                const date = new Date(value);
                if (!isNaN(date.getTime())) return date;
            }
            
            // Número (Excel Serial)
            if (typeof value === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + value * 86400000);
                if (!isNaN(date.getTime())) return date;
            }
            
            return null;
        }
        
        function handleFile(file) {
            const reader = new FileReader();
            
            contentArea.innerHTML = '<div class="loading"><div class="spinner"></div><div>Carregando dados...</div></div>';
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd'});
                    
                    workbookData = {};
                    
                    // Process each sheet
                    ['2024', '2025', '2026'].forEach(year => {
                        if (workbook.SheetNames.includes(year)) {
                            const worksheet = workbook.Sheets[year];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, dateNF: 'yyyy-mm-dd'});
                            
                            // Find header row (contains "STATUS")
                            let headerRow = -1;
                            for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                                if (jsonData[i] && jsonData[i].includes('STATUS')) {
                                    headerRow = i;
                                    break;
                                }
                            }
                            
                            if (headerRow >= 0) {
                                const headers = jsonData[headerRow];
                                const rows = jsonData.slice(headerRow + 1);
                                
                                workbookData[year] = rows
                                    .filter(row => row && row.length > 0 && row.some(cell => cell !== null && cell !== undefined && cell !== ''))
                                    .map(row => {
                                        const obj = {};
                                        headers.forEach((header, index) => {
                                            const value = row[index];
                                            
                                            // Tentar converter strings de data para objetos Date
                                            if (value && typeof value === 'string') {
                                                // Verificar se parece uma data (formato ISO ou similar)
                                                const dateMatch = value.match(/^\d{4}-\d{2}-\d{2}/);
                                                if (dateMatch) {
                                                    const parsed = new Date(value);
                                                    if (!isNaN(parsed.getTime())) {
                                                        obj[header || `col_${index}`] = parsed;
                                                        return;
                                                    }
                                                }
                                            }
                                            
                                            obj[header || `col_${index}`] = value;
                                        });
                                        return obj;
                                    });
                            }
                        }
                    });
                    
                    console.log('Dados carregados:', workbookData);
                    
                    tabsContainer.style.display = 'flex';
                    renderDashboard('2024');
                    
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    contentArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            </div>
                            <h2>Erro ao processar arquivo</h2>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Tab switching
        document.getElementById('tabsContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                const year = e.target.dataset.year;
                renderDashboard(year);
            }
        });
        
        function renderDashboard(year) {
            currentYear = year;
            
            if (year === 'geral') {
                renderGeralView();
                return;
            }
            
            const data = workbookData[year] || [];
            
            if (data.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                            </svg>
                        </div>
                        <h2>Sem dados para ${year}</h2>
                    </div>
                `;
                return;
            }
            
            // Calculate statistics
            const stats = calculateStats(data);
            
            // Render
            contentArea.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total de O.S</div>
                        <div class="stat-value">${stats.total}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Concluídas</div>
                        <div class="stat-value">${stats.concluidas}</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">Canceladas</div>
                        <div class="stat-value">${stats.canceladas}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Em Andamento</div>
                        <div class="stat-value">${stats.emAndamento}</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Status das O.S</div>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Prazo das O.S</div>
                        <canvas id="prazoChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Top 10 Bairros</div>
                        <canvas id="bairroChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Tipos de Serviço</div>
                        <canvas id="tipoChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">O.S por Mês</div>
                        <canvas id="monthChart"></canvas>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="chart-title">Lista de Ordens de Serviço</div>
                    <div class="filter-section">
                        <div class="filter-wrapper">
                            <input type="text" class="filter-input" id="filterOS" placeholder="Buscar por Nº O.S...">
                        </div>
                        <div class="filter-wrapper">
                            <input type="text" class="filter-input" id="filterEndereco" placeholder="Buscar por Endereço...">
                        </div>
                        <div class="filter-wrapper">
                            <input type="text" class="filter-input" id="filterBairro" placeholder="Buscar por Bairro...">
                        </div>
                        <div class="filter-wrapper">
                            <select class="filter-input" id="filterStatus">
                                <option value="">Todos os Status</option>
                                <option value="concluida">Concluída</option>
                                <option value="cancelada">Cancelada</option>
                                <option value="andamento">Em Andamento</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-scroll-indicator" id="scrollIndicator">
                        ← Arraste para ver mais colunas →
                    </div>
                    <div class="table-wrapper" style="max-height: 600px; overflow-y: auto;">
                        <table id="osTable">
                            <thead>
                                <tr>
                                    <th>O.S</th>
                                    <th>Data</th>
                                    <th>Endereço</th>
                                    <th>Bairro</th>
                                    <th>Serviço</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Prazo</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Render charts
            renderCharts(data, stats);
            
            // Render table
            renderTable(data);
            
            // Setup Filters and Autocomplete
            setupFiltersAndAutocomplete(data);
        }
        
        function calculateStats(data) {
            const stats = {
                total: data.length,
                concluidas: 0,
                canceladas: 0,
                emAndamento: 0,
                bairros: {},
                tipos: {},
                meses: {},
                prazos: {
                    noPrazo: 0,           // Verde: Concluida no prazo
                    emAndamentoNoPrazo: 0, // Amarelo: Em andamento (dentro do prazo)
                    concluidaForaPrazo: 0, // Laranja: Concluida fora do prazo
                    pendenteForaPrazo: 0   // Vermelho: Fora do prazo (não concluída)
                }
            };
            
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            data.forEach(row => {
                // Status
                const status = (row['STATUS'] || '').toString().toUpperCase();
                const statusText = (row['STATUS.1'] || '').toString().toUpperCase();
                const info = (row['INFORMAÇÃO'] || '').toString().toUpperCase();
                
                let isCancelada = false;
                let isConcluida = false;

                if (status.includes('CANCELADA') || statusText.includes('CANCELADA')) {
                    stats.canceladas++;
                    isCancelada = true;
                } else if (info.includes('CONCLUÍDA') || row['DATA CONCLUIDA']) {
                    stats.concluidas++;
                    isConcluida = true;
                } else {
                    stats.emAndamento++;
                }
                
                // --- Lógica de Prazos ---
                if (!isCancelada) {
                    const dataRecebida = parseDateHelper(row['DATA RECEBIDA'] || row['DATA']);
                    const prazoDias = parseInt(row['PRAZO']);
                    const dataConcluida = parseDateHelper(row['DATA CONCLUIDA']);

                    if (dataRecebida && !isNaN(prazoDias)) {
                        const dataLimite = new Date(dataRecebida);
                        dataLimite.setDate(dataLimite.getDate() + prazoDias);
                        dataLimite.setHours(23, 59, 59, 999);
                        
                        // Normalizar datas para comparação
                        if(dataConcluida) dataConcluida.setHours(0,0,0,0);

                        if (isConcluida) {
                            if (dataConcluida && dataConcluida <= dataLimite) {
                                stats.prazos.noPrazo++;
                            } else if (dataConcluida && dataConcluida > dataLimite) {
                                stats.prazos.concluidaForaPrazo++;
                            } else {
                                // Fallback se não tiver data exata mas está concluída
                                if(info.includes('FORA DO PRAZO')) stats.prazos.concluidaForaPrazo++;
                                else stats.prazos.noPrazo++; 
                            }
                        } else {
                            // Não concluída
                            if (hoje <= dataLimite) {
                                stats.prazos.emAndamentoNoPrazo++;
                            } else {
                                stats.prazos.pendenteForaPrazo++;
                            }
                        }
                    }
                }

                // Bairros
                const bairro = row['BAIRRO'] || 'Não informado';
                stats.bairros[bairro] = (stats.bairros[bairro] || 0) + 1;
                
                // Tipos
                const tipo = row['TIPO'] || 'Não informado';
                stats.tipos[tipo] = (stats.tipos[tipo] || 0) + 1;
                
                // Meses
                let dataParaProcessar = null;
                const possiveisColunasData = ['DATA RECEBIDA', 'DATA', 'DATA CONCLUIDA'];
                for (let coluna of possiveisColunasData) {
                    if (row[coluna]) {
                        dataParaProcessar = row[coluna];
                        break;
                    }
                }
                if (!dataParaProcessar) {
                    for (let key in row) {
                        if (key && key.includes && key.includes('DATA') && row[key]) {
                            dataParaProcessar = row[key];
                            break;
                        }
                    }
                }
                
                const date = parseDateHelper(dataParaProcessar);
                if (date) {
                    const mesKey = date.getMonth();
                    const mesesNomes = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 
                                       'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                    const mesNome = mesesNomes[mesKey];
                    stats.meses[mesNome] = (stats.meses[mesNome] || 0) + 1;
                }
            });
            
            return stats;
        }
        
        function renderCharts(data, stats) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e2e8f0' : '#2d3748';
            const gridColor = isDark ? '#4a5568' : '#e2e8f0';
            const isMobile = window.innerWidth <= 768;
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            // Status Chart
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Concluídas', 'Canceladas', 'Em Andamento'],
                    datasets: [{
                        data: [stats.concluidas, stats.canceladas, stats.emAndamento],
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 10, font: { size: isMobile ? 11 : 12 } }
                        }
                    }
                }
            });

            // Prazo Chart (Novo)
            new Chart(document.getElementById('prazoChart'), {
                type: 'pie', // Ou 'doughnut'
                data: {
                    labels: [
                        'Concluída no Prazo', 
                        'Em Andamento (No Prazo)', 
                        'Concluída Fora do Prazo', 
                        'Pendente (Fora do Prazo)'
                    ],
                    datasets: [{
                        data: [
                            stats.prazos.noPrazo,
                            stats.prazos.emAndamentoNoPrazo,
                            stats.prazos.concluidaForaPrazo,
                            stats.prazos.pendenteForaPrazo
                        ],
                        backgroundColor: [
                            '#48bb78', // Verde
                            '#f6ad55', // Amarelo (Usando um tom amarelado/laranja claro do tema)
                            '#ed8936', // Laranja
                            '#f56565'  // Vermelho
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 10, font: { size: isMobile ? 10 : 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                    return `${label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Bairro Chart
            const topBairros = Object.entries(stats.bairros)
                .sort((a, b) => b[1] - a[1])
                .slice(0, isMobile ? 5 : 10);
            
            new Chart(document.getElementById('bairroChart'), {
                type: 'bar',
                data: {
                    labels: topBairros.map(b => b[0]),
                    datasets: [{
                        label: 'Quantidade',
                        data: topBairros.map(b => b[1]),
                        backgroundColor: '#5a67d8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    indexAxis: isMobile ? 'y' : 'x',
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
            
            // Tipo Chart
            const topTipos = Object.entries(stats.tipos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, isMobile ? 6 : 10);
            
            new Chart(document.getElementById('tipoChart'), {
                type: 'pie',
                data: {
                    labels: topTipos.map(t => t[0]),
                    datasets: [{
                        data: topTipos.map(t => t[1]),
                        backgroundColor: [
                            '#5a67d8', '#48bb78', '#ed8936', '#f56565',
                            '#38b2ac', '#9f7aea', '#ec4899', '#f59e0b',
                            '#10b981', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 8, font: { size: isMobile ? 10 : 12 } }
                        }
                    }
                }
            });
            
            // Month Chart
            const mesesOrdenados = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 
                                     'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            const dadosMeses = mesesOrdenados.map(mes => stats.meses[mes] || 0);
            
            new Chart(document.getElementById('monthChart'), {
                type: 'line',
                data: {
                    labels: mesesOrdenados.map(m => m.toUpperCase()),
                    datasets: [{
                        label: 'O.S por Mês',
                        data: dadosMeses,
                        borderColor: '#5a67d8',
                        backgroundColor: isDark ? 'rgba(90, 103, 216, 0.2)' : 'rgba(90, 103, 216, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#5a67d8',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }
        
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // Determine status
                const status = (row['STATUS'] || '').toString().toUpperCase();
                const statusText = (row['STATUS.1'] || '').toString().toUpperCase();
                const info = (row['INFORMAÇÃO'] || '').toString().toUpperCase();
                
                let statusBadge = '';
                if (status.includes('CANCELADA') || statusText.includes('CANCELADA')) {
                    statusBadge = '<span class="status-badge status-cancelada">Cancelada</span>';
                } else if (info.includes('CONCLUÍDA') || row['DATA CONCLUIDA']) {
                    statusBadge = '<span class="status-badge status-concluida">Concluída</span>';
                } else {
                    statusBadge = '<span class="status-badge status-andamento">Em Andamento</span>';
                }
                
                // Format date
                let dataFormatada = '';
                const date = parseDateHelper(row['DATA RECEBIDA']);
                if (date) dataFormatada = date.toLocaleDateString('pt-BR');
                else if (row['DATA RECEBIDA']) dataFormatada = row['DATA RECEBIDA'];
                
                tr.innerHTML = `
                    <td>${row['O.S'] || '-'}</td>
                    <td>${dataFormatada}</td>
                    <td>${row['ENDEREÇO '] || row['ENDEREÇO'] || '-'}</td>
                    <td>${row['BAIRRO'] || '-'}</td>
                    <td>${row['SERVIÇO '] || row['SERVIÇO'] || '-'}</td>
                    <td>${row['TIPO'] || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${row['PRAZO'] || '-'}</td>
                `;
                
                tr.dataset.os = (row['O.S'] || '').toString().toLowerCase();
                tr.dataset.endereco = (row['ENDEREÇO '] || row['ENDEREÇO'] || '').toString().toLowerCase();
                tr.dataset.bairro = (row['BAIRRO'] || '').toString().toLowerCase();
                tr.dataset.status = statusBadge.includes('concluida') ? 'concluida' : 
                                    statusBadge.includes('cancelada') ? 'cancelada' : 'andamento';
                
                tbody.appendChild(tr);
            });
            
            // Show scroll indicator logic (omitted for brevity, same as before)
        }
        
        // --- Função de Autocomplete e Filtros ---
        function setupFiltersAndAutocomplete(data) {
            const filterOS = document.getElementById('filterOS');
            const filterEndereco = document.getElementById('filterEndereco');
            const filterBairro = document.getElementById('filterBairro');
            const filterStatus = document.getElementById('filterStatus');

            // 1. Extrair valores únicos para o autocomplete
            const uniqueOS = [...new Set(data.map(r => (r['O.S'] || '').toString()).filter(Boolean))];
            const uniqueEnderecos = [...new Set(data.map(r => (r['ENDEREÇO '] || r['ENDEREÇO'] || '').toString()).filter(Boolean))];
            const uniqueBairros = [...new Set(data.map(r => (r['BAIRRO'] || '').toString()).filter(Boolean))];

            // 2. Configurar Autocomplete para cada campo
            setupSingleAutocomplete(filterOS, uniqueOS);
            setupSingleAutocomplete(filterEndereco, uniqueEnderecos);
            setupSingleAutocomplete(filterBairro, uniqueBairros);
            
            // Função de aplicar filtros (mantida)
            const applyFilters = () => {
                const osValue = filterOS.value.toLowerCase();
                const enderecoValue = filterEndereco.value.toLowerCase();
                const bairroValue = filterBairro.value.toLowerCase();
                const statusValue = filterStatus.value;
                
                const rows = document.querySelectorAll('#tableBody tr');
                rows.forEach(row => {
                    const matchOS = !osValue || row.dataset.os.includes(osValue);
                    const matchEndereco = !enderecoValue || row.dataset.endereco.includes(enderecoValue);
                    const matchBairro = !bairroValue || row.dataset.bairro.includes(bairroValue);
                    const matchStatus = !statusValue || row.dataset.status === statusValue;
                    
                    if (matchOS && matchEndereco && matchBairro && matchStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            };
            
            filterOS.addEventListener('input', applyFilters);
            filterEndereco.addEventListener('input', applyFilters);
            filterBairro.addEventListener('input', applyFilters);
            filterStatus.addEventListener('change', applyFilters);
        }

        function setupSingleAutocomplete(inputElement, sourceData) {
            // Remover sugestões antigas se existirem
            const wrapper = inputElement.parentElement;
            const existingSuggestions = wrapper.querySelector('.autocomplete-suggestions');
            if (existingSuggestions) existingSuggestions.remove();

            // Criar container de sugestões
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'autocomplete-suggestions';
            wrapper.appendChild(suggestionsContainer);

            // Inicializar Fuse
            const fuse = new Fuse(sourceData, {
                threshold: 0.3,
                limit: 5 // Top 5 matches
            });

            inputElement.addEventListener('input', (e) => {
                const value = e.target.value;
                if (!value || value.length < 2) { // Só buscar após 2 caracteres
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const results = fuse.search(value);
                
                if (results.length > 0) {
                    suggestionsContainer.innerHTML = '';
                    results.forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = result.item;
                        div.addEventListener('click', () => {
                            inputElement.value = result.item;
                            suggestionsContainer.style.display = 'none';
                            // Disparar evento de input para atualizar o filtro
                            inputElement.dispatchEvent(new Event('input'));
                        });
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Fechar sugestões ao clicar fora
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        function renderGeralView() {
            // Combine all years
            const allData = Object.values(workbookData).flat();
            
            if (allData.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                            </svg>
                        </div>
                        <h2>Sem dados</h2>
                    </div>
                `;
                return;
            }
            
            const stats = calculateStats(allData);
            
            // Add year distribution
            const yearStats = {};
            Object.keys(workbookData).forEach(year => {
                yearStats[year] = workbookData[year].length;
            });
            
            contentArea.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Geral de O.S</div>
                        <div class="stat-value">${stats.total}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Concluídas</div>
                        <div class="stat-value">${stats.concluidas}</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">Canceladas</div>
                        <div class="stat-value">${stats.canceladas}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Em Andamento</div>
                        <div class="stat-value">${stats.emAndamento}</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Distribuição por Ano</div>
                        <canvas id="yearChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Status Geral</div>
                        <canvas id="statusGeralChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Prazo Geral</div>
                        <canvas id="prazoGeralChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Top 15 Bairros (Geral)</div>
                        <canvas id="bairroGeralChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Tipos de Serviço (Geral)</div>
                        <canvas id="tipoGeralChart"></canvas>
                    </div>
                </div>
            `;
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e2e8f0' : '#2d3748';
            const gridColor = isDark ? '#4a5568' : '#e2e8f0';
            const isMobile = window.innerWidth <= 768;
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            // Year Chart
            new Chart(document.getElementById('yearChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(yearStats),
                    datasets: [{
                        label: 'Quantidade de O.S',
                        data: Object.values(yearStats),
                        backgroundColor: ['#5a67d8', '#48bb78', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
            
            // Status Chart
            new Chart(document.getElementById('statusGeralChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Concluídas', 'Canceladas', 'Em Andamento'],
                    datasets: [{
                        data: [stats.concluidas, stats.canceladas, stats.emAndamento],
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 10, font: { size: isMobile ? 11 : 12 } }
                        }
                    }
                }
            });

            // Prazo Geral Chart
            new Chart(document.getElementById('prazoGeralChart'), {
                type: 'pie',
                data: {
                    labels: ['Concluída no Prazo', 'Em Andamento (No Prazo)', 'Concluída Fora do Prazo', 'Pendente (Fora do Prazo)'],
                    datasets: [{
                        data: [
                            stats.prazos.noPrazo,
                            stats.prazos.emAndamentoNoPrazo,
                            stats.prazos.concluidaForaPrazo,
                            stats.prazos.pendenteForaPrazo
                        ],
                        backgroundColor: ['#48bb78', '#f6ad55', '#ed8936', '#f56565']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor, padding: 10 } }
                    }
                }
            });
            
            // Bairro Chart
            const topBairros = Object.entries(stats.bairros)
                .sort((a, b) => b[1] - a[1])
                .slice(0, isMobile ? 8 : 15);
            
            new Chart(document.getElementById('bairroGeralChart'), {
                type: 'bar',
                data: {
                    labels: topBairros.map(b => b[0]),
                    datasets: [{
                        label: 'Quantidade',
                        data: topBairros.map(b => b[1]),
                        backgroundColor: '#5a67d8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
            
            // Tipo Chart
            const topTipos = Object.entries(stats.tipos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, isMobile ? 6 : 10);
            
            new Chart(document.getElementById('tipoGeralChart'), {
                type: 'pie',
                data: {
                    labels: topTipos.map(t => t[0]),
                    datasets: [{
                        data: topTipos.map(t => t[1]),
                        backgroundColor: [
                            '#5a67d8', '#48bb78', '#ed8936', '#f56565',
                            '#38b2ac', '#9f7aea', '#ec4899', '#f59e0b',
                            '#10b981', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 8, font: { size: isMobile ? 10 : 12 } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>